<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>PlanetSide 2 Leader Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #111; color: #eee; }
    h1 { text-align: center; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { padding: 10px; border-bottom: 1px solid #333; text-align: left; }
    tr.online { background-color: #1e3d1e; }
    tr.offline { background-color: #3d1e1e; }
    .loading { text-align: center; margin-top: 20px; font-style: italic; }
    .error { color: red; text-align: center; margin-top: 20px; }
  </style>
</head>
<body>
  <h1>PS2 Online Status Checker</h1>
  <div id="status" class="loading">Loading character list...</div>
  <table id="results" style="display:none;">
    <thead>
      <tr>
        <th>Name</th>
        <th>Status</th>
        <th>Faction</th>
      </tr>
    </thead>
    <tbody id="results-body"></tbody>
  </table>

  <script>
    const CHARACTER_LIST_URL = `https://raw.githubusercontent.com/alaschke/ps2-status-checker/data/characters.json?t=${Date.now()}`;
    const CENSUS_SERVICE_ID = "jambooga"; // Replace with your service ID if available
    

    const FACTIONS = {
      "1": "VS",
      "2": "NC",
      "3": "TR",
      "4": "NSO"
    };

    async function fetchCharacterList() {
      const response = await fetch(CHARACTER_LIST_URL);
      if (!response.ok) throw new Error("Failed to load characters.json");
      return response.json();
    }

    async function fetchCharacterStatus(name) {
      const url = `https://census.daybreakgames.com/s:${CENSUS_SERVICE_ID}/get/ps2:v2/character?name.first_lower=${name.toLowerCase()}&c:resolve=online_status`;
      const response = await fetch(url);
      const data = await response.json();
      console.log(data);
      return data.character_list?.[0] || null;
    }

    async function loadStatuses() {
      const statusDiv = document.getElementById("status");
      const table = document.getElementById("results");
      const tbody = document.getElementById("results-body");

      try {
        const names = await fetchCharacterList();
        if (!Array.isArray(names)) throw new Error("Invalid character list format");

        statusDiv.textContent = "Fetching online statuses...";

        const results = await Promise.all(names.map(fetchCharacterStatus));

        tbody.innerHTML = "";

        results.forEach(character => {
          if (!character) return;

          const row = document.createElement("tr");
          const statusCode = character.online_status;
          const faction = FACTIONS[character.faction_id] || "Unknown";
          const isOnline = statusCode === "1";

          row.className = isOnline ? "online" : "offline";

          row.innerHTML = `
            <td>${character.name.first}</td>
            <td>${isOnline ? "Online" : "Offline"}</td>
            <td>${faction}</td>
          `;

          tbody.appendChild(row);
        });

        table.style.display = "table";
        statusDiv.style.display = "none";

      } catch (error) {
        console.error(error);
        statusDiv.className = "error";
        statusDiv.textContent = "Error: " + error.message;
      }
    }

    loadStatuses();
  </script>
</body>
</html>
