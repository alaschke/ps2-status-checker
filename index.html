<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>PlanetSide 2 POI Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #111;
      color: #eee;
      width:auto;
      max-width: 1000px;
      margin: 0 auto 0;
    }
    p {text-align: center;}

    h1 {
      text-align: center;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    th,
    td {
      padding: 10px;
      border-bottom: 1px solid #333;
      text-align: left;
    }

    tr.online {
      background-color: #1e3d1e;
    }

    tr.offline {
      background-color: #3d1e1e;
    }

    .loading {
      text-align: center;
      margin-top: 20px;
      font-style: italic;
    }

    .error {
      color: red;
      text-align: center;
      margin-top: 20px;
    }
  </style>
</head>

<body>
  <h1>PS2 POI Tracker</h1>
  <p>AKA people I usually see and are likely in a platoon I might want to join.</p>
  <p>Biased against when I'm on and who my scatterbrained brain actually notices.</p>
  <div id="status" class="loading">Loading character list...</div>
  <table id="results" style="display:none;">
    <thead>
      <tr>
        <th>Name</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody id="results-body"></tbody>
  </table>

  <script>
    const CHARACTER_LIST_URL = `https://raw.githubusercontent.com/alaschke/ps2-status-checker/data/characters.json?t=${Date.now()}`;
    const CENSUS_SERVICE_ID = "jambooga";

    const FACTIONS = {
      "1": "VS",
      "2": "NC",
      "3": "TR",
      "4": "NSO"
    };


    async function fetchCharacterList() {
      const response = await fetch(CHARACTER_LIST_URL);
      if (!response.ok) throw new Error("Failed to load characters.json");
      return response.json();
    }

    async function fetchCharacterData(name) {
      const url = `https://census.daybreakgames.com/s:${CENSUS_SERVICE_ID}/get/ps2:v2/character/?name.first_lower=${name.toLowerCase()}&c:resolve=online_status,outfit,location,times`;
      const response = await fetch(url);
      const data = await response.json();
      return data.character_list?.[0] || null;
    }

    function getSessionDuration(lastLogin) {
      const now = Math.floor(Date.now() / 1000);
      const seconds = now - parseInt(lastLogin);
      const minutes = Math.floor(seconds / 60);
      const hours = Math.floor(minutes / 60);
      if (hours > 0) return `${hours}h ${minutes % 60}m`;
      return `${minutes}m`;
    }

    function getTimeAgo(timestamp) {
      const secondsAgo = Math.floor(Date.now() / 1000) - parseInt(timestamp);
      const minutes = Math.floor(secondsAgo / 60);
      const hours = Math.floor(minutes / 60);
      const days = Math.floor(hours / 24);

      if (days > 0) return `${days}d ${hours % 24}h ago`;
      if (hours > 0) return `${hours}h ${minutes % 60}m ago`;
      return `${minutes}m ago`;
    }


    async function loadStatuses() {
      const statusDiv = document.getElementById("status");
      const table = document.getElementById("results");
      const tbody = document.getElementById("results-body");

      try {
        const names = await fetchCharacterList();
        if (!Array.isArray(names)) throw new Error("Invalid character list format");

        statusDiv.textContent = "Fetching character data...";

        const rawResults = await Promise.all(names.map(fetchCharacterData));
        const results = rawResults.filter(Boolean);

        // Sort alphabetically by outfit name (or "ZZZ" if no outfit)
        results.sort((a, b) => {
          const outfitA = a.outfit?.alias || "ZZZ";
          const outfitB = b.outfit?.alias || "ZZZ";
          return outfitA.localeCompare(outfitB);
        });

        tbody.innerHTML = "";

        results.forEach(character => {
          const name = character.name?.first || "Unknown";
          const outfit = character.outfit?.alias || "";
          const statusCode = character.online_status;
          const isOnline = statusCode === "1";

          let statusText = isOnline ? "Online" : "Offline";
          let session = "â€”";
          
          if (isOnline && character.times?.last_login) {
            statusText += ` (Since: ${getSessionDuration(character.times.last_login)} ago)`;
          } else if (!isOnline && character.times?.last_save) {
            statusText += ` (Last online: ${getTimeAgo(character.times.last_save)})`;
          }

          const row = document.createElement("tr");
          row.className = isOnline ? "online" : "offline";

          row.innerHTML = `
            <td>[${outfit}] ${name}</td>
            <td>${statusText}</td>
          `;

          tbody.appendChild(row);
        });

        table.style.display = "table";
        statusDiv.style.display = "none";

      } catch (error) {
        console.error(error);
        statusDiv.className = "error";
        statusDiv.textContent = "Error: " + error.message;
      }
    }

    loadStatuses();
  </script>
</body>

</html>
